{{/* Generate monitor grafana envs */}}
{{- define "grafana.envs" }}
env:
- name: NAMESPACE
  valueFrom:
    fieldRef:
      fieldPath: metadata.namespace
{{- if eq .Values.global.influxdbLocation "off-cluster" }}
- name: "INFLUXDB_URL"
  valueFrom:
    secretKeyRef:
      name: influxdb-creds
      key: url
{{- else }}
- name: "INFLUXDB_URL"
  value: http://$(DRYCC_INFLUXDB_SERVICE_HOST):$(DRYCC_INFLUXDB_SERVICE_PORT)
{{- end }}
- name: "INFLUXDB_BUCKET"
  valueFrom:
    secretKeyRef:
      name: influxdb-creds
      key: bucket
- name: "INFLUXDB_ORG"
  valueFrom:
    secretKeyRef:
      name: influxdb-creds
      key: org
- name: "INFLUXDB_TOKEN"
  valueFrom:
    secretKeyRef:
      name: influxdb-creds
      key: token
- name: "BIND_PORT"
  value: "3000"
{{- if not (.Values.grafana.environment.DEFAULT_USER) }}
- name: "DEFAULT_USER"
  value: {{ randAlphaNum 32 | b64enc }}
{{- end}}
{{- if not (.Values.grafana.environment.DEFAULT_USER_PASSWORD) }}
- name: "DEFAULT_USER_PASSWORD"
  value: {{ randAlphaNum 32 | b64enc }}
{{- end}}
- name: "KUBERNETES_CLUSTER_DOMAIN"
  value: {{.Values.global.clusterDomain}}
{{- range $key, $value := .Values.grafana.environment }}
- name: {{ $key }}
  value: {{ $value | quote }}
{{- end }}
- name: "DRYCC_GRAFANA_URL"
{{- if .Values.global.certManagerEnabled }}
  value: https://drycc-monitor-grafana.{{ .Values.global.platformDomain }}
{{- else }}
  value: http://drycc-monitor-grafana.{{ .Values.global.platformDomain }}
{{- end }}
{{- if eq .Values.global.passportLocation "on-cluster"}}
- name: "DRYCC_PASSPORT_URL"
{{- if .Values.global.certManagerEnabled }}
  value: https://drycc-passport.{{ .Values.global.platformDomain }}
{{- else }}
  value: http://drycc-passport.{{ .Values.global.platformDomain }}
{{- end }}
- name: DRYCC_PASSPORT_KEY
  valueFrom:
    secretKeyRef:
      name: passport-creds
      key: drycc-passport-grafana-key
- name: DRYCC_PASSPORT_SECRET
  valueFrom:
    secretKeyRef:
      name: passport-creds
      key: drycc-passport-grafana-secret
{{- else }}
- name: DRYCC_PASSPORT_URL
  value: "{{ .Values.grafana.passportUrl }}"
- name: DRYCC_PASSPORT_KEY
  value: "{{ .Values.grafana.passportKey }}"
- name: DRYCC_PASSPORT_SECRET
  value: "{{ .Values.grafana.passportSecret }}"
{{- end }}
- name: "INFLUXDB_LOCATION"
  value: {{ .Values.global.influxdbLocation }}
- name: "REDIS_LOCATION"
  value: {{ .Values.global.redisLocation }}
- name: "RABBITMQ_LOCATION"
  value: {{ .Values.global.rabbitmqLocation }}
- name: "STORAGE_LOCATION"
  value: {{ .Values.global.storageLocation }}
- name: "DATABASE_LOCATION"
  value: {{ .Values.global.databaseLocation }}
- name: "PASSPORT_LOCATION"
  value: {{ .Values.global.passportLocation }}
- name: "REGISTRY_LOCATION"
  value: {{ .Values.global.registryLocation }}
{{- end }}

{{/* Generate monitor telegraf deployment envs */}}
{{- define "telegraf.deployment.envs" }}
env:
- name: POD_NAMESPACE
  valueFrom:
    fieldRef:
      fieldPath: metadata.namespace
{{- if eq .Values.global.influxdbLocation "off-cluster" }}
- name: "INFLUXDB_URLS_V2"
  valueFrom:
    secretKeyRef:
      name: influxdb-creds
      key: url
{{- else }}
- name: "INFLUXDB_URLS_V2"
  value: "\"http://$(DRYCC_INFLUXDB_SERVICE_HOST):$(DRYCC_INFLUXDB_SERVICE_PORT)\""
- name: "INFLUXDB_V2_INPUT_URLS"
  value: "\"http://$(DRYCC_INFLUXDB_SERVICE_HOST):$(DRYCC_INFLUXDB_SERVICE_PORT)/metrics\""
- name: "ENABLE_INFLUXDB_V2_INPUT"
  value: "true"
{{- end }}
- name: "INFLUXDB_BUCKET"
  valueFrom:
    secretKeyRef:
      name: influxdb-creds
      key: bucket
- name: "INFLUXDB_ORG"
  valueFrom:
    secretKeyRef:
      name: influxdb-creds
      key: org
- name: "INFLUXDB_TOKEN"
  valueFrom:
    secretKeyRef:
      name: influxdb-creds
      key: token
- name: "AGENT_QUIET"
  value: "true"
- name: "AGENT_BUFFER_LIMIT"
  value: "100000"
{{- if eq .Values.global.redisLocation "on-cluster" }}
- name: DRYCC_REDIS_ADDRS
  valueFrom:
    secretKeyRef:
      name: redis-creds
      key: addrs
- name: DRYCC_REDIS_PASSWORD
  valueFrom:
    secretKeyRef:
      name: redis-creds
      key: password
{{- end }}
{{- if eq .Values.global.storageLocation "on-cluster" }}
- name: DRYCC_STORAGE_LOOKUP
  valueFrom:
    secretKeyRef:
      name: storage-creds
      key: lookup
- name: DRYCC_STORAGE_HEALTH
  valueFrom:
    secretKeyRef:
      name: storage-creds
      key: health
- name: DRYCC_STORAGE_BUCKET
  valueFrom:
    secretKeyRef:
      name: storage-creds
      key: builder-bucket
- name: DRYCC_STORAGE_ENDPOINT
  valueFrom:
    secretKeyRef:
      name: storage-creds
      key: endpoint
- name: DRYCC_STORAGE_ACCESSKEY
  valueFrom:
    secretKeyRef:
      name: storage-creds
      key: accesskey
- name: DRYCC_STORAGE_SECRETKEY
  valueFrom:
    secretKeyRef:
      name: storage-creds
      key: secretkey
- name: DRYCC_STORAGE_PD_ADDRS
  valueFrom:
    secretKeyRef:
      name: storage-meta-creds
      key: pd-addrs
- name: DRYCC_STORAGE_TIKV_ADDRS
  valueFrom:
    secretKeyRef:
      name: storage-meta-creds
      key: tikv-addrs
{{- end }}
{{- end }}
